<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Bench Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #0d1117;
        color: #e6edf3;
        min-height: 100vh;
        padding: 2rem 1rem;
      }

      header {
        max-width: 1100px;
        margin: 0 auto 2rem;
      }

      header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #f0f6fc;
      }

      header p {
        margin-top: 0.4rem;
        color: #8b949e;
        font-size: 0.9rem;
      }

      /* Controls */
      .controls {
        max-width: 1100px;
        margin: 0 auto 1.25rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .controls label {
        font-size: 0.85rem;
        color: #8b949e;
      }

      .controls select,
      .controls input {
        background: #161b22;
        border: 1px solid #30363d;
        color: #e6edf3;
        border-radius: 6px;
        padding: 0.35rem 0.65rem;
        font-size: 0.85rem;
      }

      /* Stats bar */
      .stats {
        max-width: 1100px;
        margin: 0 auto 1.5rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: stretch;
      }

      .stat-card {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        min-width: 130px;
      }

      .stat-card .label {
        font-size: 0.75rem;
        color: #8b949e;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .stat-card .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #58a6ff;
        margin-top: 0.2rem;
      }

      .stat-chart {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 0.75rem;
        min-width: 320px;
        flex: 1 1 460px;
      }

      /* Table */
      .table-wrap {
        max-width: 1100px;
        margin: 0 auto;
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #30363d;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }

      thead {
        background: #161b22;
      }

      th {
        padding: 0.75rem 1rem;
        text-align: left;
        color: #8b949e;
        font-weight: 600;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
      }

      th:hover {
        color: #e6edf3;
      }

      th .sort-icon {
        margin-left: 4px;
        opacity: 0.4;
      }
      th.sorted .sort-icon {
        opacity: 1;
        color: #58a6ff;
      }

      tbody tr {
        border-top: 1px solid #21262d;
        transition: background 0.1s;
      }

      tbody tr:hover {
        background: #161b22;
      }

      td {
        padding: 0.65rem 1rem;
        color: #e6edf3;
        white-space: nowrap;
      }

      td.task-id {
        font-family: "SFMono-Regular", Consolas, monospace;
        color: #58a6ff;
        font-size: 0.82rem;
      }

      td.model {
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #c9d1d9;
        font-size: 0.82rem;
      }

      td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
        color: #c9d1d9;
      }

      td.tokens {
        color: #a5d6ff;
      }
      td.duration {
        color: #7ee787;
      }

      td.score {
        font-weight: 700;
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .score-bar {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .score-bar .bar {
        display: inline-block;
        height: 6px;
        border-radius: 3px;
        min-width: 2px;
      }

      .score-high {
        color: #3fb950;
      }
      .score-high .bar {
        background: #3fb950;
      }

      .score-mid {
        color: #d29922;
      }
      .score-mid .bar {
        background: #d29922;
      }

      .score-low {
        color: #f85149;
      }
      .score-low .bar {
        background: #f85149;
      }

      /* Scoring model panel */
      .score-model {
        max-width: 1100px;
        margin: 0 auto 1.5rem;
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 8px;
        padding: 1.25rem 1.5rem;
      }

      .score-model summary {
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        color: #f0f6fc;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .score-model summary::-webkit-details-marker {
        display: none;
      }

      .score-model summary::before {
        content: "▶";
        font-size: 0.7rem;
        color: #58a6ff;
        transition: transform 0.15s;
      }

      .score-model[open] summary::before {
        transform: rotate(90deg);
      }

      .score-model .formula-wrap {
        margin-top: 1rem;
      }

      .score-model .formula {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        padding: 1rem 1.25rem;
        font-family: "SFMono-Regular", Consolas, monospace;
        font-size: 0.85rem;
        color: #e6edf3;
        line-height: 1.8;
        overflow-x: auto;
      }

      .score-model .formula .keyword {
        color: #ff7b72;
        font-weight: 600;
      }

      .score-model .formula .num {
        color: #79c0ff;
      }

      .score-model .formula .comment {
        color: #8b949e;
        font-style: italic;
      }

      .score-model .penalty-table {
        margin-top: 0.75rem;
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
      }

      .score-model .penalty-table th {
        text-align: left;
        padding: 0.5rem 0.75rem;
        color: #8b949e;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        border-bottom: 1px solid #30363d;
        cursor: default;
      }

      .score-model .penalty-table td {
        padding: 0.45rem 0.75rem;
        color: #c9d1d9;
        border-bottom: 1px solid #21262d;
        white-space: normal;
      }

      .score-model .penalty-table td:first-child {
        font-family: "SFMono-Regular", Consolas, monospace;
        color: #d2a8ff;
        font-size: 0.82rem;
      }

      .score-model .penalty-table td:nth-child(2) {
        font-family: "SFMono-Regular", Consolas, monospace;
        color: #79c0ff;
      }

      .score-model .color-legend {
        margin-top: 0.75rem;
        display: flex;
        gap: 1.25rem;
        font-size: 0.8rem;
      }

      .score-model .color-legend span {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .score-model .color-legend .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .chart-wrap {
        height: 280px;
      }

      #score-chart-empty {
        display: none;
        padding: 2rem 1rem;
        text-align: center;
        color: #8b949e;
        border: 1px dashed #30363d;
        border-radius: 6px;
      }

      .empty {
        text-align: center;
        padding: 3rem;
        color: #8b949e;
      }

      footer {
        max-width: 1100px;
        margin: 2rem auto 0;
        font-size: 0.78rem;
        color: #484f58;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Agent Bench Results</h1>
      <p>Successful benchmark runs — sorted by most recent first</p>
    </header>

    <div class="stats">
      <div class="stat-chart">
        <div class="chart-wrap">
          <canvas id="score-chart" aria-label="Task score line chart" role="img"></canvas>
          <div id="score-chart-empty">No chart data for the current filters.</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <label
        >Task Name
        <input
          id="filter-task-name"
          type="text"
          placeholder="filter task..."
          style="width: 180px"
        />
      </label>
      <label
        >Model
        <input
          id="filter-model"
          type="text"
          placeholder="filter model..."
          style="width: 180px"
        />
      </label>
    </div>

    <details class="score-model">
      <summary>Scoring Model</summary>
      <div class="formula-wrap">
        <div class="formula">
          <span class="keyword">Score</span> = <span class="keyword">clamp</span>(<span class="num">0</span>, <span class="num">100</span> − iteration_penalty − duration_penalty − token_penalty, <span class="num">100</span>)<br><br>
          <span class="comment">// Penalty weights</span><br>
          iteration_penalty = iterations × <span class="num">5</span><br>
          duration_penalty &nbsp;= duration_secs × <span class="num">0.5</span><br>
          token_penalty &nbsp;&nbsp;&nbsp;&nbsp;= tokens_used × <span class="num">0.0001</span>
        </div>

        <table class="penalty-table">
          <thead>
            <tr>
              <th>Factor</th>
              <th>Weight</th>
              <th>Rationale</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>iterations</td>
              <td>-5 / iter</td>
              <td>Fewer iterations means the model solved the task more directly</td>
            </tr>
            <tr>
              <td>duration_secs</td>
              <td>-0.5 / sec</td>
              <td>Faster completion indicates better efficiency</td>
            </tr>
            <tr>
              <td>tokens_used</td>
              <td>-0.0001 / tok</td>
              <td>Lower token usage reflects more concise reasoning</td>
            </tr>
          </tbody>
        </table>

        <div class="color-legend">
          <span><span class="dot" style="background:#3fb950"></span> High (≥ 70)</span>
          <span><span class="dot" style="background:#d29922"></span> Mid (≥ 40)</span>
          <span><span class="dot" style="background:#f85149"></span> Low (&lt; 40)</span>
        </div>
      </div>
    </details>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-col="task_id">Task <span class="sort-icon">↕</span></th>
            <th data-col="model_name">
              Model <span class="sort-icon">↕</span>
            </th>
            <th data-col="iterations" class="num">
              Iterations <span class="sort-icon">↕</span>
            </th>
            <th data-col="duration_secs" class="num">
              Duration (s) <span class="sort-icon">↕</span>
            </th>
            <th data-col="tokens_used" class="num">
              Tokens <span class="sort-icon">↕</span>
            </th>
            <th data-col="score" class="num">
              Score <span class="sort-icon">↕</span>
            </th>
            <th data-col="agent_version">
              Version <span class="sort-icon">↕</span>
            </th>
            <th data-col="timestamp">
              Timestamp <span class="sort-icon">↕</span>
            </th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer id="footer"></footer>

    <script>
      let allData = [];
      let sortCol = "timestamp";
      let sortAsc = false;
      let scoreChart = null;

      async function load() {
        try {
          const res = await fetch("result.json");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          allData = await res.json();
        } catch (e) {
          document.getElementById("tbody").innerHTML =
            `<tr><td colspan="8" class="empty">Could not load result.json: ${e.message}</td></tr>`;
          return;
        }
        populateFilters();
        render();
      }

      function populateFilters() {
        document
          .getElementById("filter-task-name")
          .addEventListener("input", render);
        document
          .getElementById("filter-model")
          .addEventListener("input", render);
      }

      function filtered() {
        const taskName = document
          .getElementById("filter-task-name")
          .value.toLowerCase();
        const model = document
          .getElementById("filter-model")
          .value.toLowerCase();

        return allData.filter(
          (d) =>
            (!taskName || d.task_id.toLowerCase().includes(taskName)) &&
            (!model || d.model_name.toLowerCase().includes(model)),
        );
      }

      function sorted(data) {
        return [...data].sort((a, b) => {
          let va = sortCol === "score" ? calcScore(a) : a[sortCol],
            vb = sortCol === "score" ? calcScore(b) : b[sortCol];
          if (va == null) va = "";
          if (vb == null) vb = "";
          if (typeof va === "number") return sortAsc ? va - vb : vb - va;
          return sortAsc
            ? String(va).localeCompare(String(vb))
            : String(vb).localeCompare(String(va));
        });
      }

      /**
       * Penalty-based score: starts at 100, deducts for iterations, duration, tokens.
       *   - iterations:  5 pts each
       *   - duration:    0.5 pts per second
       *   - tokens:      0.0001 pts per token
       * Clamped to [0, 100].
       */
      function calcScore(d) {
        const iterPenalty = (d.iterations ?? 0) * 5;
        const durPenalty = (d.duration_secs ?? 0) * 0.5;
        const tokPenalty = (d.tokens_used ?? 0) * 0.0001;
        return Math.max(0, Math.min(100, 100 - iterPenalty - durPenalty - tokPenalty));
      }

      function scoreClass(score) {
        if (score >= 70) return "score-high";
        if (score >= 40) return "score-mid";
        return "score-low";
      }

      function scoreCell(d) {
        const score = calcScore(d);
        const cls = scoreClass(score);
        const barW = Math.max(2, Math.round(score * 0.6));
        return `<td class="score ${cls}"><span class="score-bar"><span class="bar" style="width:${barW}px"></span>${score.toFixed(1)}</span></td>`;
      }

      function fmt(ts) {
        const d = new Date(ts);
        return d.toISOString().replace("T", " ").substring(0, 19) + " UTC";
      }

      function pickLatestPerTaskModel(data) {
        const map = new Map();
        for (const row of data) {
          const key = `${row.task_id}:::${row.model_name}`;
          const prev = map.get(key);
          if (!prev || new Date(row.timestamp) > new Date(prev.timestamp)) {
            map.set(key, row);
          }
        }
        return [...map.values()];
      }

      function modelColor(idx, total) {
        const hue = Math.round((idx * 360) / Math.max(total, 1));
        return `hsl(${hue} 80% 62%)`;
      }

      function renderScoreChart(data) {
        const canvas = document.getElementById("score-chart");
        const empty = document.getElementById("score-chart-empty");

        if (typeof Chart === "undefined") {
          canvas.style.display = "none";
          empty.style.display = "block";
          empty.textContent = "Chart.js failed to load, so the chart is unavailable.";
          return;
        }

        const latestRows = pickLatestPerTaskModel(data);
        const tasks = [...new Set(latestRows.map((d) => d.task_id))].sort((a, b) =>
          a.localeCompare(b, undefined, { numeric: true }),
        );
        const models = [...new Set(latestRows.map((d) => d.model_name))].sort();

        if (!tasks.length || !models.length) {
          canvas.style.display = "none";
          empty.style.display = "block";
          empty.textContent = "No chart data for the current filters.";
          if (scoreChart) {
            scoreChart.destroy();
            scoreChart = null;
          }
          return;
        }

        const points = new Map(
          latestRows.map((d) => [`${d.task_id}:::${d.model_name}`, calcScore(d)]),
        );

        const datasets = models.map((model, idx) => {
          const color = modelColor(idx, models.length);
          return {
            label: model,
            data: tasks.map((taskId) => {
              const key = `${taskId}:::${model}`;
              return points.has(key) ? points.get(key) : null;
            }),
            borderColor: color,
            backgroundColor: color,
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            spanGaps: true,
            tension: 0.2,
          };
        });

        canvas.style.display = "block";
        empty.style.display = "none";

        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(canvas, {
          type: "line",
          data: {
            labels: tasks,
            datasets,
          },
          options: {
            maintainAspectRatio: false,
            interaction: {
              mode: "nearest",
              intersect: false,
            },
            plugins: {
              legend: {
                labels: {
                  color: "#c9d1d9",
                  boxWidth: 12,
                },
              },
            },
            scales: {
              x: {
                ticks: { color: "#8b949e", maxRotation: 35, minRotation: 0 },
                grid: { color: "#21262d" },
                title: { display: true, text: "Tasks", color: "#8b949e" },
              },
              y: {
                min: 0,
                max: 100,
                ticks: { color: "#8b949e" },
                grid: { color: "#21262d" },
                title: { display: true, text: "Score", color: "#8b949e" },
              },
            },
          },
        });
      }

      function render() {
        const data = sorted(filtered());

        renderScoreChart(data);

        // Table
        const tbody = document.getElementById("tbody");
        if (data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="empty">No results match the current filters.</td></tr>`;
          return;
        }

        tbody.innerHTML = data
          .map(
            (d) => `
      <tr>
        <td class="task-id">${esc(d.task_id)}</td>
        <td class="model" title="${esc(d.model_name)}">${esc(d.model_name)}</td>
        <td class="num">${d.iterations}</td>
        <td class="num duration">${d.duration_secs.toFixed(2)}</td>
        <td class="num tokens">${d.tokens_used != null ? d.tokens_used.toLocaleString() : "—"}</td>
        ${scoreCell(d)}
        <td class="model">${esc(d.agent_version)}</td>
        <td>${fmt(d.timestamp)}</td>
      </tr>`,
          )
          .join("");

        document.getElementById("footer").textContent =
          `Last updated: ${fmt(new Date().toISOString())} · ${data.length} run(s) shown`;
      }

      function esc(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      // Sort on header click
      document.querySelectorAll("th[data-col]").forEach((th) => {
        th.addEventListener("click", () => {
          const col = th.dataset.col;
          if (sortCol === col) {
            sortAsc = !sortAsc;
          } else {
            sortCol = col;
            sortAsc = col !== "timestamp";
          }

          document
            .querySelectorAll("th")
            .forEach((h) => h.classList.remove("sorted"));
          th.classList.add("sorted");
          th.querySelector(".sort-icon").textContent = sortAsc ? "↑" : "↓";
          render();
        });
      });

      load();
    </script>
  </body>
</html>
